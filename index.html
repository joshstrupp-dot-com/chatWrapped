<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-8YB6Y5TRJ1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-8YB6Y5TRJ1");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Wrapped - Time and energy spent on ChatGPT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
      // 1. Load Pyodide and needed packages
      let analyze; // will hold our Python function
      let pyodideReady = false;
      let pyodideInstance; // will hold the pyodide instance

      function showStatus(message, isError = false) {
        const results = document.getElementById("results");
        results.innerHTML = `<div class="status-message ${
          isError ? "error-message" : ""
        }">${message}</div>`;
        console.log(isError ? "ERROR:" : "STATUS:", message);
      }

      async function initPyodide() {
        try {
          console.log("Initializing Pyodide...");
          showStatus("üîÑ Loading Python environment...");

          pyodideInstance = await loadPyodide();
          console.log("Pyodide loaded, loading pandas...");
          showStatus("üì¶ Loading data processing packages...");

          await pyodideInstance.loadPackage("pandas");
          console.log("Pandas loaded, defining analyzer function...");

          // 2. Define the analyzer in Python
          await pyodideInstance.runPythonAsync(`
import io, zipfile, json
import pandas as pd
from datetime import datetime

def analyze_zip(data_bytes):
    # Let Python know we're starting to process the zip file and how big it is
    print(f"Processing zip file of size: {len(data_bytes)} bytes")

    # Try to open the zip file and get the conversations out of it
    try:
        # Turn the bytes into a zip file we can read
        z = zipfile.ZipFile(io.BytesIO(data_bytes))
        print(f"Zip file opened successfully. Files: {z.namelist()}")

        # Make sure the file we need is in there
        if "conversations.json" not in z.namelist():
            raise Exception("conversations.json not found in zip file")

        # Get the conversation data and turn it from bytes into text
        raw_json = z.read("conversations.json")
        print(f"conversations.json size: {len(raw_json)} bytes")

        # Turn the text into a Python object we can work with
        raw = json.loads(raw_json)
        print(f"Parsed JSON with {len(raw)} conversations")

    except Exception as e:
        # If anything goes wrong, let us know what happened
        print(f"Error processing zip: {str(e)}")
        raise e

    # This will hold all the messages we find
    msgs = []

    # Look through each conversation
    for i, conv in enumerate(raw):
        # Each conversation has a "mapping" of messages
        mapping = conv.get("mapping", {})
        for m in mapping.values():
            msg = m.get("message")
            if not msg: continue
            # Get the actual text content from the message
            parts = msg.get("content",{}).get("parts",[])
            text = "\\n".join(str(p) for p in parts if p)
            # Save important info about each message
            msgs.append({
                "role": msg["author"].get("role","unknown"),  # who wrote it (user or assistant)
                "chars": len(text),                           # how many characters
                "words": len(text.split()),                   # how many words
                "content": text,                              # actual message content
                "create_time": msg.get("create_time", None)   # message creation timestamp
            })

    print(f"Extracted {len(msgs)} messages")

    # Make sure we found some messages
    if not msgs:
        raise Exception("No messages found in the conversations")

    # Turn our list of messages into a table we can analyze
    df = pd.DataFrame(msgs)
    # Split into user messages and assistant messages
    user = df[df.role=="user"]
    asst = df[df.role=="assistant"]

    print(f"User messages: {len(user)}, Assistant messages: {len(asst)}")

    # Find longest and shortest user messages
    longest_user_msg = ""
    shortest_user_msg = ""
    if len(user) > 0:
        longest_idx = user.chars.idxmax()
        longest_user_msg = df.loc[longest_idx, 'content']

        # For shortest message, only consider messages with at least 1 character
        user_with_content = user[user.chars > 0]
        if len(user_with_content) > 0:
            shortest_idx = user_with_content.chars.idxmin()
            shortest_user_msg = df.loc[shortest_idx, 'content']
        else:
            # If all user messages are empty, use the first one
            shortest_user_msg = df.loc[user.index[0], 'content']

    # Calculate energy consumption and comparisons
    total_energy = float(df.chars.sum()*0.000010)
    tesla_miles = total_energy * 4.0                         # Tesla drives ~4 miles per kWh
    microwave_hours = total_energy / 1.2                     # Microwave uses ~1.2 kWh per hour
    
    # Get start and end dates and format them
    start_timestamp = min(msg['create_time'] for msg in msgs if msg['create_time'])
    end_timestamp = max(msg['create_time'] for msg in msgs if msg['create_time'])
    
    # Convert Unix timestamps to readable dates
    start_date = datetime.fromtimestamp(start_timestamp).strftime("%B %d, %Y")
    end_date = datetime.fromtimestamp(end_timestamp).strftime("%B %d, %Y")
    
    # Return interesting stats about the conversations:
    return {
        "total_user_msgs":        int(len(user)),            # how many messages the user sent
        "total_user_chars":       int(user.chars.sum()),     # total characters typed by user
        "hours_typing":           float(user.chars.sum()/200/60),  # estimate time spent typing (200 chars/min)
        "total_asst_msgs":        int(len(asst)),            # how many messages from assistant
        "total_asst_chars":       int(asst.chars.sum()),     # total characters from assistant
        "hours_reading":          float(asst.words.sum()/237.5/60),  # estimate time spent reading (237.5 words/min)
        "total_energy_kWh":       total_energy,              # rough estimate of energy used
        "tesla_miles":            float(tesla_miles),        # equivalent miles a Tesla could drive
        "microwave_hours":        float(microwave_hours),    # equivalent hours running a microwave
        "longest_user_msg":       str(longest_user_msg),     # content of longest user message
        "shortest_user_msg":      str(shortest_user_msg),    # content of shortest user message
        "start_date":             start_date,                # earliest message date (formatted)
        "end_date":               end_date                   # latest message date (formatted)
    }
`);
          analyze = pyodideInstance.globals.get("analyze_zip");
          pyodideReady = true;
          console.log("Analyzer ready!");
          showStatus("‚úÖ Ready! Please select your ChatGPT export zip file.");

          // Enable the file input and upload button only once Pyodide is ready
          document.getElementById("zip-input").disabled = false;
          document.getElementById("upload-button").classList.remove("disabled");
        } catch (error) {
          console.error("Failed to initialize Pyodide:", error);
          showStatus(`‚ùå Failed to initialize: ${error.message}`, true);
        }
      }

      // 3. Wire up file-input once Pyodide is ready
      window.addEventListener("DOMContentLoaded", async () => {
        // Disable file input initially
        document.getElementById("zip-input").disabled = true;

        await initPyodide();

        document
          .getElementById("zip-input")
          .addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) {
              console.log("No file selected");
              return;
            }

            console.log(`File selected: ${file.name} (${file.size} bytes)`);

            if (!pyodideReady) {
              showStatus(
                "‚ùå Python environment not ready yet. Please wait.",
                true
              );
              return;
            }

            try {
              showStatus("üîÑ Processing your ChatGPT export...");

              console.log("Reading file data...");
              const arrayBuffer = await file.arrayBuffer();
              const data = new Uint8Array(arrayBuffer);
              console.log(`File data loaded: ${data.length} bytes`);

              console.log("Converting data for Python...");
              // Convert JavaScript Uint8Array to Python bytes
              const pythonBytes = pyodideInstance.toPy(data);

              console.log("Running analysis...");
              const pythonResult = analyze(pythonBytes);
              const res = pythonResult.toJs({
                dict_converter: Object.fromEntries,
              });
              console.log("Analysis complete:", res);

              // Helper function to truncate long messages for display
              function truncateMessage(msg, maxLength = 200) {
                if (msg.length <= maxLength) return msg;
                return msg.substring(0, maxLength) + "...";
              }

              // 4. Render results in Chat Wrapped style
              document.getElementById("results").innerHTML = `
                <div class="results-container">
                  <!-- Divider -->
                  <div class="divider">================================</div>
                  
                  <!-- Date Range Section -->
                  <div class="date-section">
                    <div class="date-label">FROM</div>
                    <div class="date-value">${res.start_date}</div>
                    <div class="date-label">TO</div>
                    <div class="date-value">${res.end_date}</div>
                  </div>

                  <!-- Divider -->
                  <div class="divider">================================</div>

                  <!-- Time spent writing -->
                  <div class="metric-section">
                    <div class="metric-label">Time spent writing <span class="metric-value">${Math.round(
                      res.hours_typing / 2
                    )} hrs</span></div>
                    <div class="metric-footnote">
                      Messages you sent, estimated based on the American typing rate average of 200 characters per minute. Divides the number by two assuming that roughly half of what you send is copied and pasted.
                    </div>
                    <div class="metric-description">
                      With this amount of time, you could have written <span class="highlight">${Math.round(
                        (res.hours_typing / 2) * (60 / 7)
                      )} postcards</span> to your loved ones. Shame on you! Or searched through an encyclopedia for the answer <span class="highlight">${Math.round(
                (res.hours_typing / 2) * (60 / 9)
              )} times</span>. What a waste of time! Just use ChatGPT!
                    </div>
                  </div>

                  <!-- Time spent reading -->
                  <div class="metric-section">
                    <div class="metric-label">Time spent reading <span class="metric-value">${Math.round(
                      res.hours_reading
                    )} hrs</span></div>
                    <div class="metric-footnote">
                      Messages sent by ChatGPT, estimated based on the American reading rate average of 237.5 characters per minute.
                    </div>
                    <div class="metric-description">
                      With this amount of time, you could have read the Bible <span class="highlight">${(
                        res.hours_reading / 59
                      ).toFixed(
                        2
                      )} times</span> cover to cover. <i>Somebody</i> needs Christ. 
                    </div>
                  </div>

                  <!-- Energy used -->
                  <div class="metric-section">
                    <div class="metric-label">Energy used <span class="metric-value">${Math.round(
                      res.total_energy_kWh
                    )} kWh</span></div>
                    <div class="metric-footnote">
                      kWh, or kilowatt hours, is an estimate of energy used. We use a rate of 0.000010 kWh per character, based on reported LLM energy averages.
                    </div>
                    <div class="metric-description">
                      Your usage is equivalent to driving <span class="highlight">${Math.round(
                        res.tesla_miles
                      )} miles</span> in a Tesla or running a microwave for <span class="highlight">${Math.round(
                res.microwave_hours * 60
              )} minutes</span>. Maybe... idk, plant a tree to offset it?
                    </div>
                  </div>
                  <!-- Longest message -->
                  <div class="metric-section">
                    <div class="metric-label">Longest message</div>
                    <div class="message-content">
                      ${res.longest_user_msg
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")}
                    </div>
                  </div>

                  <!-- Shortest message -->
                  <div class="metric-section">
                    <div class="metric-label">Shortest message</div>
                    <div class="message-content">
                      ${res.shortest_user_msg
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")}
                    </div>
                  </div>

                  <!-- Final divider -->
                  <div class="divider">================================</div>

                  <!-- Share section -->
                  <div class="share-section">
                    <div class="share-button" onclick="shareResults(${JSON.stringify(
                      res
                    ).replace(/"/g, "&quot;")})">Share your results</div>
                    <div class="metric-description">
                      Copy a shareable message with your Chat Wrapped stats
                    </div>
                  </div>

                  <!-- See the code section -->
                  <div class="code-section">
                    <div class="blue-button">See the code</div>
                    <div class="metric-description">
                      <a href="https://github.com/joshstrupp-dot-com/chatWrapped" target="_blank" class="code-link">Check out how it works</a>! This was largely (and somewhat ironically) an AI-assisted project, so please do call out errors you find.
                    </div>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error("Analysis failed:", error);
              showStatus(`‚ùå Analysis failed: ${error.message}`, true);
            }
          });
      });

      // Share functionality
      function shareResults(results) {
        const shareText = `ü§ñ My Chat Wrapped Results ü§ñ

üìÖ From ${results.start_date} to ${results.end_date}

‚úçÔ∏è Time spent writing: ${Math.round(results.hours_typing / 2)} hours
üìñ Time spent reading: ${Math.round(results.hours_reading)} hours
‚ö° Energy used: ${Math.round(results.total_energy_kWh)} kWh
üöó Equivalent to driving ${Math.round(results.tesla_miles)} miles in a Tesla

Try it yourself: https://joshstrupp-dot-com.github.io/chatWrapped/`;

        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(shareText)
            .then(() => {
              showShareFeedback("‚úÖ Copied to clipboard!");
            })
            .catch(() => {
              fallbackCopyToClipboard(shareText);
            });
        } else {
          fallbackCopyToClipboard(shareText);
        }
      }

      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand("copy");
          showShareFeedback("‚úÖ Copied to clipboard!");
        } catch (err) {
          showShareFeedback("‚ùå Copy failed. Please copy manually.");
          console.error("Fallback copy failed:", err);
        }

        document.body.removeChild(textArea);
      }

      function showShareFeedback(message) {
        const shareButton = document.querySelector(".share-button");
        const originalText = shareButton.textContent;
        shareButton.textContent = message;
        shareButton.style.backgroundColor = message.includes("‚úÖ")
          ? "#28a745"
          : "#dc3545";

        setTimeout(() => {
          shareButton.textContent = originalText;
          shareButton.style.backgroundColor = "#154bff";
        }, 2000);
      }
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier Prime", "Courier New", monospace;
        background-color: #2c2c2c;
        color: #000000;
        line-height: 1.3;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        padding: 30px 25px;
        position: relative;
        background-color: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border-radius: 0;
        /* Receipt paper texture */
        background-image: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 24px,
          rgba(0, 0, 0, 0.03) 25px
        );
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px dashed #000;
        padding-bottom: 20px;
      }

      .title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
        text-align: center;
        letter-spacing: 2px;
        text-transform: uppercase;
      }

      .subtitle {
        font-size: 12px;
        font-weight: 400;
        text-align: center;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .divider {
        font-size: 14px;
        font-weight: 400;
        text-align: center;
        margin: 20px 0;
        color: #000000;
        letter-spacing: 1px;
      }

      /* FAQ Sections */
      .faq-section {
        margin-bottom: 25px;
        border-bottom: 1px dashed #ccc;
        padding-bottom: 20px;
      }

      .blue-button {
        background-color: #000;
        color: #ffffff;
        padding: 8px 12px;
        text-align: center;
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: none;
      }

      .faq-content {
        font-size: 14px;
        font-weight: 400;
        line-height: 1.4;
        margin-bottom: 20px;
        margin-top: 10px;
        text-align: left;
      }

      /* Upload Section */
      .upload-section {
        text-align: center;
        margin: 30px 0;
        position: relative;
        border-top: 2px dashed #000;
        border-bottom: 2px dashed #000;
        padding: 20px 0;
      }

      .upload-button {
        background-color: #ffffff;
        border: 2px solid #000;
        color: #000000;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 700;
        text-decoration: none;
        text-transform: uppercase;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        margin: 10px 0;
        display: inline-block;
        position: relative;
        overflow: hidden;
        letter-spacing: 1px;
        transition: all 0.2s ease;
      }

      .upload-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        background-color: #f8f8f8;
      }

      .upload-button.disabled {
        background-color: #ccc;
        border-color: #ccc;
        color: #666;
        cursor: not-allowed;
        opacity: 0.7;
      }

      .upload-button.disabled:hover {
        transform: none;
        box-shadow: none;
        background-color: #ccc;
      }

      input[type="file"] {
        position: absolute;
        opacity: 0;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 1;
      }

      .video-container {
        width: 100%;
        margin: 20px 0;
        text-align: center;
        border: 1px solid #000;
        padding: 10px;
      }

      .video-container video {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 0;
        border: 1px solid #ccc;
      }

      /* Results Section */
      .results-container {
        margin-top: 20px;
      }

      .date-section {
        text-align: center;
        margin: 20px 0;
        border-bottom: 1px dashed #ccc;
        padding-bottom: 15px;
      }

      .date-label {
        font-size: 12px;
        color: #000;
        font-weight: 700;
        margin: 5px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .date-value {
        font-size: 14px;
        color: #000;
        font-weight: 400;
        margin: 5px 0;
      }

      .metric-section {
        text-align: left;
        margin: 15px 0;
        border-bottom: 1px dotted #ddd;
        padding-bottom: 10px;
      }

      .metric-label {
        font-size: 14px;
        color: #000;
        font-weight: 700;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .metric-value {
        font-size: 18px;
        color: #000;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 8px;
        text-align: right;
        float: right;
      }

      .metric-description {
        font-size: 12px;
        color: #666;
        font-weight: 400;
        line-height: 1.3;
        text-align: left;
        clear: both;
        margin-top: 5px;
      }

      .metric-footnote {
        font-size: 8px;
        color: #999;
        font-weight: 400;
        line-height: 1.2;
        text-align: left;
        clear: both;
        margin-top: 3px;
        margin-bottom: 8px;
        font-style: italic;
      }

      .highlight {
        color: #000;
        font-weight: 700;
      }

      .message-content {
        font-size: 10px;
        color: #000000;
        font-weight: 400;
        line-height: 1.3;
        text-align: left;
        margin: 10px 0;
        padding: 10px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 0;
        max-height: 150px;
        overflow-y: auto;
        font-family: "Courier Prime", "Courier New", monospace;
      }

      .share-section {
        text-align: center;
        margin: 30px 0;
        border-top: 2px dashed #000;
        padding-top: 20px;
      }

      .share-button {
        background-color: #000;
        color: #ffffff;
        padding: 10px 20px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        border-radius: 0;
        display: inline-block;
        margin-bottom: 10px;
        transition: background-color 0.2s;
        user-select: none;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .share-button:hover {
        background-color: #333;
        transform: none;
      }

      .share-button:active {
        transform: none;
      }

      .code-section {
        text-align: center;
        margin: 30px 0;
        border-top: 1px dashed #ccc;
        padding-top: 15px;
      }

      .code-link {
        color: #000000;
        text-decoration: underline;
        font-size: 10px;
      }

      .code-link:hover {
        color: #666;
      }

      /* Status messages */
      #results {
        min-height: auto;
        background: transparent;
        padding: 0;
        margin: 0;
      }

      .status-message {
        text-align: center;
        font-size: 12px;
        color: #000;
        font-weight: 700;
        margin: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 10px;
        /* border: 1px dashed #000; */
      }

      .error-message {
        color: #000 !important;
        background-color: #f5f5f5;
        border-color: #000 !important;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 20px 15px;
          max-width: 350px;
        }

        .title {
          font-size: 20px;
        }

        .subtitle {
          font-size: 10px;
        }

        .metric-value {
          font-size: 14px;
        }

        .upload-button {
          font-size: 12px;
          padding: 10px 16px;
        }

        .divider {
          font-size: 12px;
          word-break: break-all;
        }

        .video-container video {
          height: 150px;
        }
      }

      @media (max-width: 480px) {
        .container {
          max-width: 300px;
          padding: 15px 10px;
        }

        .metric-value {
          font-size: 12px;
        }

        .faq-content,
        .metric-description {
          font-size: 10px;
        }

        .upload-button {
          font-size: 10px;
          padding: 8px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="title">Chat Wrapped</div>
        <div class="subtitle">Time and energy spent on ChatGPT</div>
      </div>

      <div class="divider">================================</div>

      <!-- What is this? -->
      <div class="faq-section">
        <div class="blue-button">What is this?</div>
        <div class="faq-content">
          It's simple really. You talk to ChatGPT. Maybe a lot, maybe a little.
          It's hard to gauge, isn't it?
          <br /><br />
          With Chat Wrapped, we can get close. Or we can try. Here, you can
          estimate time spend writing to your new robot pal, how much time you
          spend reading its response, and roughly how much energy it all takes.
          <br /><br />
          It's like Spotify Wrapped, but less interesting and more depressing.
        </div>
      </div>

      <!-- How do I start? -->
      <div class="faq-section">
        <div class="blue-button">How do I start?</div>
        <div class="faq-content">
          Export your ChatGPT data, wait for daddy Sam to email you a .zip, and
          upload it here.

          <!-- Video -->
          <div class="video-container">
            <video controls width="100%" height="314">
              <source src="export-demo.mp4" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </div>
        </div>
      </div>

      <!-- Wtf is this secure? -->
      <div class="faq-section">
        <div class="blue-button">Wtf is this secure?</div>
        <div class="faq-content">
          Sure is. It runs using Pyodide. In short, it runs an app on your
          browser, so your data isn't shared to anyone. It lives on your
          computer and in your cache.
        </div>
      </div>

      <!-- Upload Section -->
      <div class="upload-section">
        <div class="upload-button disabled" id="upload-button">
          Upload your .zip
          <input type="file" id="zip-input" accept=".zip" />
        </div>
      </div>

      <!-- Results Section -->
      <div id="results" class="status-message">üîÑ Initializing...</div>
    </div>
  </body>
</html>
